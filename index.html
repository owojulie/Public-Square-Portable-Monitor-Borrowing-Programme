<!DOCTYPE html>
<html lang="en">
<head>
  <title>Kampala Community Air Quality Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Montserrat', sans-serif; }
    #map { height:100vh; width:100%; }

    .branding {
      position:absolute;
      top:20px;
      left:20px;
      z-index:1200;
      background:#fff;
      padding:16px;
      border-radius:14px;
      box-shadow:0 10px 28px rgba(0,0,0,0.18);
      max-width:340px;
    }
    .branding h1 {
      margin:0;
      font-size:16px;
      font-weight:800;
      color:#2c3e50;
    }
    .branding p {
      margin-top:6px;
      font-size:12px;
      color:#7f8c8d;
    }

    .start-label {
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
      box-shadow:0 8px 18px rgba(0,0,0,0.18);
      border:1px solid rgba(0,0,0,0.08);
      white-space:nowrap;
    }

    .legend {
      background:white;
      padding:12px;
      line-height:20px;
      border-radius:12px;
      font-size:12px;
      box-shadow:0 0 15px rgba(0,0,0,0.2);
    }
    .legend i {
      width:15px;
      height:15px;
      float:left;
      margin-right:8px;
      border-radius:50%;
      opacity:0.85;
    }
  </style>
</head>

<body>

<div class="branding">
  <h1>Public Square Portable Monitor Programme</h1>
  <p>Community-led air quality monitoring across Kampala.</p>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
const dataFiles = [
  { file: "julian.csv", contributor: "Owomugisha Julian" },
  { file: "raymond.csv", contributor: "Mujuni Raymond" },
  { file: "ritah.csv", contributor: "Arinaitwe Ritah" },
  { file: "joseph.csv", contributor: "Joseph Beyanga" }
];

const map = L.map('map').setView([0.3136, 32.5811], 12);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  { attribution:'&copy; OpenStreetMap &copy; CARTO' }
).addTo(map);

function getPmColor(v){
  if (v >= 250.5) return '#800000';
  if (v >= 150.5) return '#800080';
  if (v >= 55.5)  return '#FF0000';
  if (v >= 35.5)  return '#FFA500';
  if (v >= 12.1)  return '#FFFF00';
  return '#00FF00';
}

const allPoints = [];
const contributorPoints = {};

dataFiles.forEach(item=>{
  Papa.parse(item.file, {
    download:true,
    header:true,
    dynamicTyping:true,
    complete:function(results){

      const rows = results.data || [];
      contributorPoints[item.contributor] = [];

      rows.forEach(r=>{
        const lat = r.Latitude || r.latitude || r.lat;
        const lng = r.Longitude || r.longitude || r.lng;
        const pm  = r["PM 2.5"] || r["PM2.5"] || r.pm25;

        if(lat && lng && pm){
          allPoints.push([lat,lng]);
          contributorPoints[item.contributor].push([lat,lng]);

          L.circleMarker([lat,lng],{
            radius:5,
            fillColor:getPmColor(pm),
            color:"transparent",
            fillOpacity:0.7
          }).addTo(map)
          .bindPopup(`<b>${item.contributor}</b><br>${pm} µg/m³`);
        }
      });

      // Place midpoint label
      const pts = contributorPoints[item.contributor];
      if(pts.length > 0){
        const midIndex = Math.floor(pts.length / 2);
        const mid = pts[midIndex];

        const labelIcon = L.divIcon({
          className:"",
          html:`<div class="start-label">${item.contributor}</div>`,
          iconSize:[1,1]
        });

        L.marker(mid,{
          icon:labelIcon,
          interactive:false
        }).addTo(map);
      }

      // Auto zoom after all files
      if(Object.keys(contributorPoints).length === dataFiles.length){
        if(allPoints.length){
          map.fitBounds(allPoints,{padding:[50,50]});
        }
      }
    }
  });
});

// Legend
const legend = L.control({position:'bottomleft'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  const grades=[0,12.1,35.5,55.5,150.5,250.5];
  const labels=['Good','Moderate','Unhealthy (Sens.)','Unhealthy','Very Unhealthy','Hazardous'];

  div.innerHTML+='<b>PM2.5 Index</b><br>';
  for(let i=0;i<grades.length;i++){
    div.innerHTML+='<i style="background:'+getPmColor(grades[i]+1)+'"></i>'+labels[i]+'<br>';
  }
  return div;
};
legend.addTo(map);
</script>

</body>
</html>
