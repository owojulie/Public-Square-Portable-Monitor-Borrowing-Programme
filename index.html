<script>
  const map = L.map('map', { zoomControl: false }).setView([0.3136, 32.5811], 12);
  L.control.zoom({ position: 'topright' }).addTo(map);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  function getPmColor(pmValue) {
    if (pmValue >= 250.5) return '#800000';
    if (pmValue >= 150.5) return '#800080';
    if (pmValue >= 55.5)  return '#FF0000';
    if (pmValue >= 35.5)  return '#FFA500';
    if (pmValue >= 12.1)  return '#FFFF00';
    return '#00FF00';
  }

  const dataFiles = [
    { file: "julian.csv", contributor: "Owomugisha Julian" },
    { file: "raymond.csv", contributor: "Mujuni Raymond" },
    { file: "ritah.csv", contributor: "Arinaitwe Ritah" },
    { file: "joseph1.csv", contributor: "Joe Walker" },
    { file: "joseph.csv", contributor: "Joseph Beyanga" },
    { file: "jackie.csv", contributor: "Jackline Asiimwe" },
    { file: "raymondz.csv", contributor: "Raymond" },
    { file: "mackline.csv", contributor: "Arinda Mackline" },
    { file: "joel.csv", contributor: "Joel Mukisa" },
    { file: "canary.csv", contributor: "Mugume Canary" },
    { file: "julian1.csv", contributor: "Tabaro Julian" },
    { file: "julian2.csv", contributor: "Tabaro Julian" },
    { file: "julian3.csv", contributor: "Owomugisha Julian" },
    { file: "inasio.csv", contributor: "Inasio Govule" },
    { file: "boda.csv", contributor: "Boda Boda Man" }
  ];

  // helpful: show errors in console if a CSV fails
  function loadCsv(item) {
    Papa.parse(item.file, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(results) {
        if (!results.data || results.data.length === 0) {
          console.warn("No data in:", item.file);
          return;
        }

        results.data.forEach(row => {
          const lat = row.Latitude ?? row.latitude ?? row.lat;
          const lng = row.Longitude ?? row.longitude ?? row.lon ?? row.lng;

          // Sometimes headers differ; try a few common variants:
          const pmValue =
            row["PM 2.5"] ?? row["PM2.5"] ?? row["PM_2_5"] ?? row["pm2_5"] ?? row["pm25"];

          if (lat && lng && pmValue !== undefined && pmValue !== null && pmValue !== "") {
            L.circleMarker([lat, lng], {
              radius: 5,
              fillColor: getPmColor(pmValue),
              color: "transparent",
              weight: 0,
              fillOpacity: 0.7
            })
            .addTo(map)
            .bindPopup(`
              <div style="font-family: Montserrat; text-align: center;">
                <strong style="font-size: 14px;">${item.contributor}</strong><br>
                <span style="font-size: 12px; color: #555;">PM2.5 Level</span><br>
                <strong style="font-size: 18px; color: ${getPmColor(pmValue)};">${pmValue} µg/m³</strong>
              </div>
            `);
          }
        });
      },
      error: function(err) {
        console.error("PapaParse failed for:", item.file, err);
      }
    });
  }

  dataFiles.forEach(loadCsv);

  // Legend
  const legend = L.control({position: 'bottomleft'});
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    const grades = [0, 12.1, 35.5, 55.5, 150.5, 250.5];
    const labels = ['Good', 'Moderate', 'Unhealthy (Sens.)', 'Unhealthy', 'Very Unhealthy', 'Hazardous'];

    div.innerHTML += '<b>PM2.5 Index</b><br>';
    for (let i = 0; i < grades.length; i++) {
      div.innerHTML +=
        '<i style="background:' + getPmColor(grades[i] + 1) + '"></i> ' +
        labels[i] + '<br>';
    }
    return div;
  };
  legend.addTo(map);
</script>
